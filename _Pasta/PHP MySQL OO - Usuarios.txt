<?php
include_once 'Conexao.class.php';

class Usuario
{

    // Função para efetuar o Login
    public function logar($login, $senha) {

        // Verificar se os campos Login e Senha estão preenchidos
        if (empty($login) || empty($senha)) {
            echo '
            <div class="col-md-4 mx-auto alert alert-warning">
                <i class="fa-solid fa-circle-exclamation"></i> 
                <strong>Atenção!!! Preencha todos os Campos</strong>
            </div>
            ';
        } else {
            // Verificar se o Login existe no Banco de Dados
            $sql = 'SELECT * FROM tab_usuarios WHERE login = ?';
            $query = Conexao::getConexao()->prepare($sql);
            $query->bindValue(1, $login);
            $query->execute();
            $dados = $query->fetchAll(PDO::FETCH_ASSOC);

            if (count($dados) > 0) {
                $senha = hash('sha256', $senha);
                $sql = 'SELECT senha FROM tab_usuarios WHERE login = ?';
                $query = Conexao::getConexao()->prepare($sql);
                $query->bindValue(1, $login);
                $query->execute();
                $dados = $query->fetch(PDO::FETCH_ASSOC);

                // Validando se as Senhas batem
                if ($senha == $dados['senha']) {

                    // Pegando as informações do Usuário
                    $sql = 'SELECT * FROM tab_usuarios WHERE login = ?';
                    $query = Conexao::getConexao()->prepare($sql);
                    $query->bindValue(1, $login);
                    $query->execute();
                    $dados = $query->fetch(PDO::FETCH_ASSOC);

                    // Iniciando a Session
                    session_start();
                    $_SESSION['id_usuario'] = $dados['id_usuario'];
                    $_SESSION['nome'] = $dados['nome'];
                    $_SESSION['email'] = $dados['email'];
                    $_SESSION['login'] = $dados['login'];
                    $_SESSION['nivel'] = $dados['nivel'];

                    // Enviar para outra página
                    if ($senha == hash('sha256', '123')) {
                        header('Location: altera-senha-padrao.php');
                    } else {
                        if ($dados['nivel'] == 0) {
                            header('Location: logado.php');
                        } else {
                            header('Location: comum.php');
                        }
                    }
                    

                // Se a senha não estiver certa
                } else {
                    echo '
                        <div class="col-md-4 mx-auto alert alert-warning">
                            <i class="fa-solid fa-circle-exclamation"></i> 
                            <strong>Senha Incorreta!!!</strong>
                        </div>
                    ';
                }
            
            // Se o Login não existir
            } else {
                echo '
                    <div class="col-md-4 mx-auto alert alert-warning">
                        <i class="fa-solid fa-circle-exclamation"></i> 
                        <strong>Usuário não Cadastrado</strong>
                    </div>
                ';
            }

        }
    }





    // Calcular a quantidade de registros por página
    public function paginacao($query, $registros_por_pagina)
    {
        $posicao_inicial = 0;
        if (isset($_GET['pagina_no'])) {
            $posicao_inicial = ($_GET['pagina_no'] - 1) * $registros_por_pagina;
        }
        $query2 = $query . " limit $posicao_inicial, $registros_por_pagina";
        return $query2;
    }





    // Mostra dados na tela de admin
    public function mostraDadosAdmin($query)
    {
        $mostra = Conexao::getConexao()->prepare($query);
        $mostra->execute();

        if ($mostra->rowCount() > 0) {
            while ($linha = $mostra->fetch(PDO::FETCH_ASSOC)) {
                ?>
                <tr>
                    <td class="text-center align-middle">
                        <?php echo $linha['id_usuario']; ?>
                    </td>

                    <td class="align-middle">
                        <?php echo $linha['nome']; ?>
                    </td>

                    <td class="align-middle">
                        <?php echo $linha['email']; ?>
                    </td>

                    <td class="text-center align-middle">
                        <?php echo $linha['login']; ?>
                    </td>

                    <!-- Nível -->
                    <td class="text-center align-middle">
                        <?php 
                            if ($linha['nivel'] == 1) {
                                echo '<i class="fa-solid fa-lock"></i>';
                            } else {
                                echo '<i class="fa-solid fa-lock-open text-danger"></i>';
                            }
                        ?>
                    </td>

                    <!-- Alterar -->
                    <td class="text-center align-middle">
                        <a href="altera-usuario.php?id_usuario=<?php echo $linha['id_usuario']; ?>" data-toggle="tooltip"
                            data-placement="right" title="Alterar">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </a>
                    </td>

                    <!-- Excluir -->
                    <td class="text-center align-middle">
                        <?php
                            if ($linha['login'] == 'admin') {
                                echo '<i class="fa-solid fa-hand" style="color: #EEEE00;" data-toggle="tooltip" data-placement="right" title="Impossível Excluir Admin!"></i>';
                            } else {
                                echo '
                                <a href="exclui-usuario.php?id_usuario='. $linha['id_usuario'] .'" data-toggle="tooltip"
                                data-placement="right" title="Excluir">
                                <i class="fa-solid fa-trash"></i>
                                </a>
                                ';
                            }
                        ?>
                        
                    </td>

                    <!-- Situação -->
                    <td class="text-center align-middle">

                        <?php
                            if ($linha['login'] == 'admin') {
                                echo '<i class="fa-solid fa-hand" style="color: #EEEE00;" data-toggle="tooltip" data-placement="right" title="Impossível Mudar Situação do Admin!"></i>';
                            } else {
                                if ($linha['ativo'] == 1) {
                                    echo '
                                            <a href="desativa-usuario.php?id_usuario=' . $linha['id_usuario'] . '"
                                            data-toggle="tooltip" data-placement="right" title="Desativar">
                                                <i class="fa-solid fa-check text-success"></i>
                                            </a>
                                        ';
                                } else {
                                    echo '
                                            <a href="ativa-usuario.php?id_usuario=' . $linha['id_usuario'] . '"
                                            data-toggle="tooltip" data-placement="right" title="Ativar">
                                                <i class="fa-solid fa-xmark text-danger"></i>
                                            </a>
                                        ';
                                }
                            }
                        ?>
                    </td>

                    <!-- Imprimir -->
                    <td class="text-center align-middle">
                        <a href="imprime-usuario.php?id_usuario=<?php echo $linha['id_usuario']; ?>" data-toggle="tooltip"
                            data-placement="right" title="Imprimir">
                            <i class="fa-solid fa-print"></i>
                        </a>
                    </td>
                </tr>
                <?php
            }
        } else {
            ?>
            <tr>
                <td colspan="10" class="alert alert-danger text-center">
                    <h5>Não há registros!</h5>
                </td>
            </tr>
            <?php
        }
    }





    // Função para criar os links de paginação
    public function link_paginacao($query, $registros_por_pagina)
    {
        $self = $_SERVER['PHP_SELF'];
        $mostra = Conexao::getConexao()->prepare($query);
        $mostra->execute();
        $total_registros = $mostra->rowCount();
        if ($total_registros > 0) {
            echo '<ul class="pagination justify-content-center">';
            $total_de_paginas = ceil($total_registros / $registros_por_pagina);
            $pagina_atual = 1;
            if (isset($_GET['pagina_no'])) {
                $pagina_atual = $_GET['pagina_no'];
            }





            // Links Primeira e Voltar
            if ($pagina_atual != 1) {
                $anterior = $pagina_atual - 1;
                echo '
                    <li class="page-item"><a href="' . $self . '?pagina_no=1" class="page-link"><i class="fas fa-angle-double-left"></i></a></li>
                    ';

                echo '
                    <li class="page-item"><a href="' . $self . '?pagina_no=' . $anterior . '" class="page-link"><i class="fas fa-angle-left"></i></a></li>
                    ';
            } else {
                echo '
                    <li class="page-item disabled"><a href="#" class="page-link"><i class="fas fa-angle-double-left"></i></a></li>
                    ';

                echo '
                    <li class="page-item disabled"><a href="#" class="page-link"><i class="fas fa-angle-left"></i></a></li>
                    ';
            }



            // Links das Páginas Centrais
            for ($i = 1; $i <= $total_de_paginas; $i++) {
                if ($i == $pagina_atual) {
                    echo '<li class="page-item active">
                        <a href="' . $self . '?pagina_no=' . $i . '" class="page-link">' . $i . '</a>
                        </li>';
                } else {
                    echo '<li class="page-item">
                        <a href="' . $self . '?pagina_no=' . $i . '" class="page-link">' . $i . '</a>
                        </li>';
                }
            }



            // Links Ultima e Avançar
            if ($pagina_atual < $total_de_paginas) {
                $proxima = $pagina_atual + 1;
                echo '
                    <li class="page-item"><a href="' . $self . '?pagina_no=' . $proxima . '" class="page-link"><i class="fas fa-angle-right"></i></a></li>
                    ';

                echo '
                    <li class="page-item"><a href="' . $self . '?pagina_no=' . $total_de_paginas . '" class="page-link"><i class="fas fa-angle-double-right"></i></a></li>
                    ';


            } else {
                echo '
                    <li class="page-item disabled"><a href="#" class="page-link"><i class="fas fa-angle-right"></i></a></li>
                    ';

                echo '
                    <li class="page-item disabled"><a href="#" class="page-link"><i class="fas fa-angle-double-right"></i></a></li>
                    ';
            }

            echo '</ul>';
        }
    }





    // Função para Inserir Usuário
    public function insere($nome, $email, $login, $nivel) {
        $sql = 'SELECT * FROM tab_usuarios WHERE email = :email OR login = :login';
        try {
            $query = Conexao::getConexao()->prepare($sql);
            $query->bindParam(':email', $email);
            $query->bindParam(':login', $login);
            $query->execute();

            if ($query->rowCount() > 0) {

                echo '
            <!-- Bootstrap -->
            <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
            <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

            <script type="text/javascript">
                $("document").ready(function() {
                    $("#emailExiste").modal("show");
                });
            </script>
        ';

            } else {

                $sql = 'INSERT INTO tab_usuarios (nome, email, login, senha, frase, nivel, ativo)
                VALUES (:nome, :email, :login, :senha, "Padrão", :nivel, 1)';

                try {

                    $senha = '123';
                    $senha = hash('sha256', $senha);

                    $query = Conexao::getConexao()->prepare($sql);
                    $query->bindParam(':nome', $nome);
                    $query->bindParam(':email', $email);
                    $query->bindParam(':login', $login);
                    $query->bindParam(':senha', $senha);
                    $query->bindParam(':nivel', $nivel);
                    $query->execute();

                    echo '
            <!-- Bootstrap -->
            <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
            <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

            <script type="text/javascript">
                $("document").ready(function() {
                    $("#ok").modal("show");
                });
            </script>
        ';

                } catch (PDOException $e) {
                    echo $e->getMessage();
                }
            }
        } catch (PDOException $e) {
            echo $e->getMessage();
        }
    }





    // Função para excluir um Usuário
    public function exclui($id_usuario) {
        $sql = 'DELETE FROM tab_usuarios WHERE id_usuario = :id_usuario LIMIT 1';
        try {

            $query = Conexao::getConexao()->prepare($sql);
            $query->bindParam(':id_usuario', $id_usuario);
            $query->execute();

        } catch (PDOException $e) {
            echo $e->getMessage();
        }
    }





    // Função para desativar Usuário
    public function desativa($id_usuario) {
        $sql = 'UPDATE tab_usuarios
                SET ativo = 0
                WHERE id_usuario = :id_usuario';

        try {

            $query = Conexao::getConexao()->prepare($sql);
            $query->bindParam(':id_usuario', $id_usuario);
            $query->execute();

        } catch (PDOException $e) {
            echo $e->getMessage();
        }
    }

    // Função para ativar Usuário
    public function ativa($id_usuario) {
        $sql = 'UPDATE tab_usuarios
                SET ativo = 1
                WHERE id_usuario = :id_usuario';

        try {

            $query = Conexao::getConexao()->prepare($sql);
            $query->bindParam(':id_usuario', $id_usuario);
            $query->execute();

        } catch (PDOException $e) {
            echo $e->getMessage();
        }
    }




    // Função para retornar valores de um registro, baseado no ID
    public function busca($id_usuario) {
        $sql = 'SELECT * FROM tab_usuarios WHERE id_usuario = :id_usuario';
        try {
            $query = Conexao::getConexao()->prepare($sql);
            $query->bindParam(':id_usuario', $id_usuario);
            $query->execute();
            $resultado = $query->fetch(PDO::FETCH_ASSOC);
            return $resultado;
        } catch (PDOException $e) {
            echo $e->getMessage();
        }
    }





    // Função para Alterar um Usuário
    public function altera($id_usuario, $nome, $email, $login, $nivel) {
        $sql = 'SELECT * FROM tab_usuarios
                WHERE (email = :email OR login = :login)
                AND id_usuario <> :id_usuario';
        try {
            $query = Conexao::getConexao()->prepare($sql);
            $query->bindParam(':email', $email);
            $query->bindParam(':login', $login);
            $query->bindParam(':id_usuario', $id_usuario);
            $query->execute();

            if ($query->rowCount() > 0) {

                echo '
                    <!-- Bootstrap -->
                    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
                    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

                    <script type="text/javascript">
                        $("document").ready(function() {
                            $("#emailExiste").modal("show");
                        });
                    </script>
                ';
            } else {

                $sql = 'UPDATE tab_usuarios
                SET nome = :nome, email = :email, login = :login, nivel = :nivel
                WHERE id_usuario = :id_usuario';

                try {

                    $query = Conexao::getConexao()->prepare($sql);
                    $query->bindParam(':nome', $nome);
                    $query->bindParam(':email', $email);
                    $query->bindParam(':login', $login);
                    $query->bindParam(':nivel', $nivel);
                    $query->bindParam(':id_usuario', $id_usuario);
                    $query->execute();

                    echo '
            <!-- Bootstrap -->
            <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
            <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

            <script type="text/javascript">
                $("document").ready(function() {
                    $("#ok").modal("show");
                });
            </script>
        ';

                } catch (PDOException $e) {
                    echo $e->getMessage();
                }

            }
        } catch (PDOException $e) {
            echo $e->getMessage();
        }
    }





    public function alteraSenhaPadrao($id_usuario, $senha, $frase) {
        $sql = 'UPDATE tab_usuarios
                SET senha = :senha, frase = :frase
                WHERE id_usuario = :id_usuario';

        try {

            $query = Conexao::getConexao()->prepare($sql);
            $query->bindParam(':senha', $senha);
            $query->bindParam(':frase', $frase);
            $query->bindParam(':id_usuario', $id_usuario);
            $query->execute();

            echo '
                <!-- Bootstrap -->
                <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
                <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

                <script type="text/javascript">
                    $("document").ready(function() {
                        $("#ok").modal("show");
                    });
                </script>
            ';

            

        } catch (PDOException $e) {
            echo $e->getMessage();
        }
    }
















}

?>