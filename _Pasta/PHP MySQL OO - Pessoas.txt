
<?php
include_once 'Conexao.class.php';
class Pessoas
{
    // Calcular a quantidade de registros por página
    public function paginacao($query, $registros_por_pagina)
    {
        $posicao_inicial = 0;
        if (isset($_GET['pagina_no'])) {
            $posicao_inicial = ($_GET['pagina_no'] - 1) * $registros_por_pagina;
        }
        $query2 = $query . " limit $posicao_inicial, $registros_por_pagina";
        return $query2;
    }



    // Mostra dados na tela inicial
    public function mostraDados($query)
    {
        $mostra = Conexao::getConexao()->prepare($query);
        $mostra->execute();

        if ($mostra->rowCount() > 0) {
            while ($linha = $mostra->fetch(PDO::FETCH_ASSOC)) {
                ?>
                <tr>
                    <td class="text-center align-middle">
                        <?php echo $linha['id_pessoa']; ?>
                    </td>

                    <td class="align-middle">
                        <?php echo $linha['nome']; ?>
                    </td>

                    <td class="align-middle">
                        <?php echo $linha['email']; ?>
                    </td>

                    <td class="text-center align-middle">
                        <?php echo $linha['fone']; ?>
                    </td>

                    <td class="text-center align-middle">
                        <?php echo date('d/m/Y', strtotime($linha['criado_em'])); ?>
                    </td>

                    <td class="text-center align-middle">
                        <img src="img_peq/<?php echo $linha['foto']; ?>" alt="">
                    </td>
                </tr>
                <?php
            }
        } else {
            ?>
            <tr>
                <td colspan="6" class="alert alert-danger text-center">
                    <h5>Não há registros!</h5>
                </td>
            </tr>
            <?php
        }
    }



    // Mostra dados na tela de admin
    public function mostraDadosAdmin($query)
    {
        $mostra = Conexao::getConexao()->prepare($query);
        $mostra->execute();

        if ($mostra->rowCount() > 0) {
            while ($linha = $mostra->fetch(PDO::FETCH_ASSOC)) {
                ?>
                <tr>
                    <td class="text-center align-middle">
                        <?php echo $linha['id_pessoa']; ?>
                    </td>

                    <td class="align-middle">
                        <?php echo $linha['nome']; ?>
                    </td>

                    <td class="align-middle">
                        <?php echo $linha['email']; ?>
                    </td>

                    <td class="text-center align-middle">
                        <?php echo $linha['fone']; ?>
                    </td>

                    <td class="text-center align-middle">
                        <?php echo date('d/m/Y', strtotime($linha['criado_em'])); ?>
                    </td>

                    <td class="text-center align-middle">
                        <img src="../img_peq/<?php echo $linha['foto']; ?>" alt="">
                    </td>

                    <!-- Alterar -->
                    <td class="text-center align-middle">
                        <a href="altera-pessoa.php?id_pessoa=<?php echo $linha['id_pessoa']; ?>" data-toggle="tooltip"
                            data-placement="right" title="Alterar">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </a>
                    </td>

                    <!-- Excluir -->
                    <td class="text-center align-middle">
                        <a href="exclui-pessoa.php?id_pessoa=<?php echo $linha['id_pessoa']; ?>" data-toggle="tooltip"
                            data-placement="right" title="Excluir">
                            <i class="fa-solid fa-trash"></i>
                        </a>
                    </td>

                    <!-- Situação -->
                    <td class="text-center align-middle">
                        <?php
                        if ($linha['ativo'] == 1) {
                            echo '
                                    <a href="desativa-pessoa.php?id_pessoa=' . $linha['id_pessoa'] . '"
                                    data-toggle="tooltip" data-placement="right" title="Desativar">
                                        <i class="fa-solid fa-check text-success"></i>
                                    </a>
                                ';
                        } else {
                            echo '
                                    <a href="ativa-pessoa.php?id_pessoa=' . $linha['id_pessoa'] . '"
                                    data-toggle="tooltip" data-placement="right" title="Ativar">
                                        <i class="fa-solid fa-xmark text-danger"></i>
                                    </a>
                                ';
                        }
                        ?>
                    </td>

                    <!-- Imprimir -->
                    <td class="text-center align-middle">
                        <a href="imprime-pessoa.php?id_pessoa=<?php echo $linha['id_pessoa']; ?>" data-toggle="tooltip"
                            data-placement="right" title="Imprimir">
                            <i class="fa-solid fa-print"></i>
                        </a>
                    </td>
                </tr>
                <?php
            }
        } else {
            ?>
            <tr>
                <td colspan="10" class="alert alert-danger text-center">
                    <h5>Não há registros!</h5>
                </td>
            </tr>
            <?php
        }
    }









    // Função para criar os links de paginação
    public function link_paginacao($query, $registros_por_pagina)
    {
        $self = $_SERVER['PHP_SELF'];
        $mostra = Conexao::getConexao()->prepare($query);
        $mostra->execute();
        $total_registros = $mostra->rowCount();
        if ($total_registros > 0) {
            echo '<ul class="pagination justify-content-center">';
            $total_de_paginas = ceil($total_registros / $registros_por_pagina);
            $pagina_atual = 1;
            if (isset($_GET['pagina_no'])) {
                $pagina_atual = $_GET['pagina_no'];
            }





            // Links Primeira e Voltar
            if ($pagina_atual != 1) {
                $anterior = $pagina_atual - 1;
                echo '
                    <li class="page-item"><a href="' . $self . '?pagina_no=1" class="page-link"><i class="fas fa-angle-double-left"></i></a></li>
                    ';

                echo '
                    <li class="page-item"><a href="' . $self . '?pagina_no=' . $anterior . '" class="page-link"><i class="fas fa-angle-left"></i></a></li>
                    ';
            } else {
                echo '
                    <li class="page-item disabled"><a href="#" class="page-link"><i class="fas fa-angle-double-left"></i></a></li>
                    ';

                echo '
                    <li class="page-item disabled"><a href="#" class="page-link"><i class="fas fa-angle-left"></i></a></li>
                    ';
            }



            // Links das Páginas Centrais
            for ($i = 1; $i <= $total_de_paginas; $i++) {
                if ($i == $pagina_atual) {
                    echo '<li class="page-item active">
                        <a href="' . $self . '?pagina_no=' . $i . '" class="page-link">' . $i . '</a>
                        </li>';
                } else {
                    echo '<li class="page-item">
                        <a href="' . $self . '?pagina_no=' . $i . '" class="page-link">' . $i . '</a>
                        </li>';
                }
            }



            // Links Ultima e Avançar
            if ($pagina_atual < $total_de_paginas) {
                $proxima = $pagina_atual + 1;
                echo '
                    <li class="page-item"><a href="' . $self . '?pagina_no=' . $proxima . '" class="page-link"><i class="fas fa-angle-right"></i></a></li>
                    ';

                echo '
                    <li class="page-item"><a href="' . $self . '?pagina_no=' . $total_de_paginas . '" class="page-link"><i class="fas fa-angle-double-right"></i></a></li>
                    ';


            } else {
                echo '
                    <li class="page-item disabled"><a href="#" class="page-link"><i class="fas fa-angle-right"></i></a></li>
                    ';

                echo '
                    <li class="page-item disabled"><a href="#" class="page-link"><i class="fas fa-angle-double-right"></i></a></li>
                    ';
            }

            echo '</ul>';
        }
    }





    // Função para Ativar uma Pessoa
    public function ativa($id_pessoa)
    {

        try {
            $sql = 'UPDATE tab_pessoas
                    SET ativo = 1
                    WHERE id_pessoa = :id_pessoa';

            $query = Conexao::getConexao()->prepare($sql);
            $query->bindParam(':id_pessoa', $id_pessoa);
            $query->execute();
            return true;
        } catch (PDOException $e) {
            echo $e->getMessage();
            return false;
        }

    }

    // Função para Desativar uma Pessoa
    public function desativa($id_pessoa)
    {

        try {
            $sql = 'UPDATE tab_pessoas
                    SET ativo = 0
                    WHERE id_pessoa = :id_pessoa';

            $query = Conexao::getConexao()->prepare($sql);
            $query->bindParam(':id_pessoa', $id_pessoa);
            $query->execute();
            return true;
        } catch (PDOException $e) {
            echo $e->getMessage();
            return false;
        }

    }





    // Função para Excluir uma Pessoa
    public function exclui($id_pessoa)
    {

        try {
            $sql = 'DELETE FROM tab_pessoas
                    WHERE id_pessoa = :id_pessoa';

            $query = Conexao::getConexao()->prepare($sql);
            $query->bindParam(':id_pessoa', $id_pessoa);
            $query->execute();
            return true;
        } catch (PDOException $e) {
            echo $e->getMessage();
            return false;
        }

    }





    // Função para inserir uma Pessoa
    public function insere($nome, $email, $fone, $foto)
    {
        $sql = 'SELECT * FROM tab_pessoas WHERE email = :email';
        try {
            $query = Conexao::getConexao()->prepare($sql);
            $query->bindParam(':email', $email);
            $query->execute();

            if ($query->rowCount() > 0) {
                echo '
                    <!-- Bootstrap -->
                    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
                    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

                    <script type="text/javascript">
                        $("document").ready(function() {
                            $("#emailExiste").modal("show");
                        });
                    </script>
                ';
            } else {
                $sql = 'INSERT INTO tab_pessoas (nome, email, fone, criado_em, foto, ativo)
                        VALUES (?, ?, ?, NOW(), ?, 1)';

                try {

                    $query = Conexao::getConexao()->prepare($sql);
                    $query->bindValue(1, $nome);
                    $query->bindValue(2, $email);
                    $query->bindValue(3, $fone);
                    $query->bindValue(4, $foto);
                    $query->execute();

                    echo '
                        <!-- Bootstrap -->
                        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
                        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

                        <script type="text/javascript">
                            $("document").ready(function() {
                                $("#ok").modal("show");
                            });
                        </script>
                    ';

                } catch (PDOException $e) {
                    echo $e->getMessage();
                }
            }
        } catch (PDOException $e) {
            echo $e->getMessage();
        }
    }





    // Função para buscar os dados de uma pessoa com base no ID
    public function busca($id_pessoa)
    {
        $sql = 'SELECT * FROM tab_pessoas WHERE id_pessoa = :id_pessoa';

        try {
            $query = Conexao::getConexao()->prepare($sql);
            $query->bindParam(':id_pessoa', $id_pessoa);
            $query->execute();
            $resultado = $query->fetch(PDO::FETCH_ASSOC);
            return $resultado;
        } catch (PDOException $e) {
            echo $e->getMessage();
            return false;
        }
    }





    // Método para alterar Pessoa
    public function altera($nome, $fone, $id_pessoa)
    {
        $sql = 'UPDATE tab_pessoas
                SET nome = :nome, fone = :fone
                WHERE id_pessoa = :id_pessoa';
        try {

            $query = Conexao::getConexao()->prepare($sql);
            $query->bindParam(':nome', $nome);
            $query->bindParam(':fone', $fone);
            $query->bindParam(':id_pessoa', $id_pessoa);
            $query->execute();

            echo '
                <!-- Bootstrap -->
                <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
                <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

                <script type="text/javascript">
                    $("document").ready(function() {
                        $("#ok").modal("show");
                    });
                </script>
            ';

        } catch (PDOException $e) {
            echo $e->getMessage();
        }
    }





    // Método para alterar foto da Pessoa
    public function alteraFoto($id_pessoa, $foto)
    {
        $sql = 'UPDATE tab_pessoas
                SET foto = :foto
                WHERE id_pessoa = :id_pessoa';

        try {

            $query = Conexao::getConexao()->prepare($sql);
            $query->bindParam(':foto', $foto);
            $query->bindParam(':id_pessoa', $id_pessoa);
            $query->execute();
            return true;

        } catch (PDOException $e) {
            echo $e->getMessage();
        }
    }







}
?>


































